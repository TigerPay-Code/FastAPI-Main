<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>QR with center icon — Canvas merge</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #out { width: 300px; height: 300px; }
</style>
</head>
<body>

<canvas id="out" width="300" height="300"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
  const canvas = document.getElementById('out');
  const ctx = canvas.getContext('2d');
  const size = canvas.width; // 300
  const textToEncode = 'https://example.com';

  // 1) 生成二维码到一个临时 canvas（qrious 会返回 canvas）
  const qr = new QRious({
    value: textToEncode,
    size: size,
    level: 'H' // 关键：纠错等级设为 H（高）
  });

  // 把生成的 qr.canvas 绘制到主 canvas
  ctx.drawImage(qr.canvas, 0, 0);

  // 2) 载入图标并绘制白底 + 图标（异步）
  const icon = new Image();
  // 如果是跨域图标，确保服务器允许 CORS 或使用同域图片，否则 toDataURL 会被污点污染
  icon.crossOrigin = 'anonymous';
  icon.src = 'https://via.placeholder.com/300x300.png?text=LOGO'; // 换成你的 logo 链接或 dataURL
  icon.onload = () => {
    // 比例控制：图标占二维码的比例（0.2 = 20%）
    const iconRatio = 0.20;
    const iconSize = Math.floor(size * iconRatio);

    // 白色底的 padding（留白），以防颜色干扰
    const padding = Math.floor(iconSize * 0.15); // 15% 的内边距
    const bgSize = iconSize + padding * 2;

    const cx = size / 2;
    const cy = size / 2;
    const bgX = Math.round(cx - bgSize / 2);
    const bgY = Math.round(cy - bgSize / 2);

    // 绘制白色圆角背景（也可以绘制圆形：arc + clip）
    const radius = Math.round(bgSize * 0.14); // 圆角大小
    ctx.fillStyle = 'white';
    roundRect(ctx, bgX, bgY, bgSize, bgSize, radius);
    ctx.fill();

    // 如果希望更强的分离感可以再加一圈细灰色边框（可选）
    // ctx.strokeStyle = '#ddd';
    // ctx.lineWidth = 2;
    // roundRect(ctx, bgX, bgY, bgSize, bgSize, radius);
    // ctx.stroke();

    // 绘制 logo（居中，留出 padding）
    const iconX = Math.round(cx - iconSize / 2);
    const iconY = Math.round(cy - iconSize / 2);

    // 可选：让 logo 也是圆角显示 —— 用 clip
    ctx.save();
    roundRectClip(ctx, iconX, iconY, iconSize, iconSize, Math.round(iconSize * 0.15));
    ctx.drawImage(icon, iconX, iconY, iconSize, iconSize);
    ctx.restore();

    // 现在 canvas 包含完整二维码 + 居中 logo，可导出
    // const dataUrl = canvas.toDataURL('image/png');
    // console.log(dataUrl);
  };

  // 绘制圆角矩形（用于白色背景）
  function roundRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
  }

  // clip 版本（用于把 logo 裁成圆角）
  function roundRectClip(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
    ctx.clip();
  }
</script>

</body>
</html>
