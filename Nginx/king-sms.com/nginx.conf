# 定义Nginx运行的用户和组
user www-data;

# 根据CPU核心数自动设置worker进程数量（2核服务器通常设置为2）
worker_processes auto;

# 存储主进程ID的文件路径
pid /run/nginx.pid;

# 包含已启用模块的配置文件
include /etc/nginx/modules-enabled/*.conf;

# 事件处理模块配置
events {
	# 每个worker进程同时打开的最大连接数
    # 对于2G内存服务器，768是合理值，可根据实际连接数调整 4G内存 1500最好
	worker_connections 768;

	# 允许同时接受多个新连接
	multi_accept on;
}

# HTTP服务器配置
http {
	# 开启高效文件传输模式
	sendfile on;

	# 仅在sendfile开启时有效，减少网络报文段数量
	tcp_nopush on;

	# 禁用Nagle算法，提高响应速度
	tcp_nodelay on;

	# 客户端保持连接超时时间
	keepalive_timeout 65;

	# 服务器名字哈希表的最大值
	types_hash_max_size 2048;

	# 限制客户端请求体大小（防止大文件上传导致资源耗尽）
    client_max_body_size 10m;

	# 包含MIME类型定义文件
	include /etc/nginx/mime.types;

	# 默认MIME类型
	default_type application/octet-stream;

	# 支持的SSL/TLS协议版本
	ssl_protocols TLSv1.2 TLSv1.3; # 移除了 TLSv1 TLSv1.1 

	# 优先使用服务器端的加密算法
	ssl_prefer_server_ciphers on;

	# 访问日志和错误日志路径
	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	# 开启Gzip压缩（节省带宽，对1M带宽特别重要）
	gzip on;

	# 限制连接速率和请求速率（防止滥用，保护1M带宽）
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=addr:10m;


	# HTTP 监听，不做重定向
    server {
        listen 80;
        listen [::]:80;

        server_name	king-sms.com www.king-sms.com;

        root /data/FastAPI-Main/templates;       # 静态文件根目录
        index index.html;

        location / {
            try_files $uri $uri.html  $uri/ =404;
        }

        location /static/ {
            alias /data/FastAPI-Main/static/;       # 渲染目录
        }
    }

    # HTTPS 监听
    server {
        listen 443;
        listen [::]:443;

        server_name king-sms.com www.king-sms.com;

        ssl_protocols	TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;

        root /data/FastAPI-Main/templates;
        index index.html;

        location / {
            try_files $uri $uri/ =404;
        }

        location /static/ {
            alias /data/FastAPI-Main/static/;
        }
    }

    server {
        listen 80;

        server_name	api.king-sms.com;

		# 安全增强配置
		server_tokens off;
		client_max_body_size 10m;
		client_body_timeout 30s;
		client_header_timeout 30s;

		ssl_protocols	TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://127.0.0.1:8960;
            proxy_set_header Host $host;
			proxy_set_header User-Agent $http_user_agent;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300;
			
			# 添加连接超时设置
			proxy_connect_timeout 30;
			proxy_send_timeout 30;
        }
    }

	server {
        listen 80;

        server_name	notify.king-sms.com;

		# 安全增强配置
		server_tokens off;
		client_max_body_size 10m;
		client_body_timeout 30s;
		client_header_timeout 30s;

		ssl_protocols	TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://127.0.0.1:4911;
            proxy_set_header Host $host;
			proxy_set_header User-Agent $http_user_agent;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300;
			
			# 添加连接超时设置
			proxy_connect_timeout 30;
			proxy_send_timeout 30;
        }
    }
}